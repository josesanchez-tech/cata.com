<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGCP ‚Äî Consulta de Proveedores</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07090f;
  --surface: #0f1420;
  --surface2: #161d2e;
  --surface3: #1e2740;
  --border: #243050;
  --border2: #2e3d60;
  --accent: #4f8ef7;
  --accent2: #7eb0ff;
  --gold: #f0b429;
  --green: #0ec97f;
  --red: #f0614a;
  --purple: #a78bfa;
  --text: #dce7ff;
  --text-dim: #8da3cc;
  --text-muted: #4d6a99;
}
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  background-image:
    radial-gradient(ellipse 80% 40% at 50% -10%, rgba(79,142,247,0.12) 0%, transparent 70%);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 32px;
  border-bottom: 1px solid var(--border);
  background: rgba(7,9,15,0.9);
  backdrop-filter: blur(12px);
  position: sticky; top: 0; z-index: 200;
}
.logo { width: 32px; height: 32px; background: linear-gradient(135deg,#4f8ef7,#f0b429); border-radius: 7px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
header h1 { font-family:'Syne',sans-serif; font-size:1.15rem; font-weight:700; letter-spacing:-0.02em; }
header h1 span { color: var(--accent2); }
.hbadge { margin-left:auto; font-family:'JetBrains Mono',monospace; font-size:0.65rem; background:rgba(79,142,247,0.1); border:1px solid rgba(79,142,247,0.25); color:var(--accent2); padding:4px 10px; border-radius:20px; }

/* ‚îÄ‚îÄ SEARCH SCREEN ‚îÄ‚îÄ */
#searchScreen { max-width: 680px; margin: 0 auto; padding: 64px 24px; }
.search-hero { text-align:center; margin-bottom:40px; }
.search-hero h2 { font-family:'Syne',sans-serif; font-size: clamp(2rem,5vw,3rem); font-weight:800; letter-spacing:-0.04em; line-height:1.1; margin-bottom:10px; }
.search-hero h2 em { font-style:italic; color:var(--accent2); }
.search-hero p { color:var(--text-dim); font-weight:300; font-size:0.95rem; }

.search-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 28px;
}
.search-card label { display:block; font-family:'JetBrains Mono',monospace; font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:8px; }
.search-row { display:flex; gap:10px; }
.search-row input {
  flex:1; background:var(--surface2); border:1px solid var(--border2);
  color:var(--text); padding:13px 16px; border-radius:11px;
  font-family:'Inter',sans-serif; font-size:0.95rem; outline:none;
  transition: border-color .2s, box-shadow .2s;
}
.search-row input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(79,142,247,0.15); }
.search-row input::placeholder { color:var(--text-muted); }
.btn { padding:13px 22px; border-radius:11px; border:none; cursor:pointer; font-family:'Inter',sans-serif; font-weight:600; font-size:0.88rem; transition:all .2s; }
.btn-primary { background:var(--accent); color:white; }
.btn-primary:hover { background:#3a78e8; transform:translateY(-1px); }
.btn-ghost { background:var(--surface2); border:1px solid var(--border2); color:var(--text-dim); }
.btn-ghost:hover { border-color:var(--accent); color:var(--accent2); }
.btn-sm { padding:8px 16px; font-size:0.8rem; }

.search-hints { margin-top:16px; display:flex; flex-wrap:wrap; gap:8px; }
.hint { font-size:0.78rem; color:var(--text-muted); background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:5px 12px; cursor:pointer; transition:all .15s; }
.hint:hover { color:var(--accent2); border-color:rgba(79,142,247,0.3); }
.hint span { color:var(--text-dim); }

/* ‚îÄ‚îÄ RESULTS LIST ‚îÄ‚îÄ */
#resultsList { margin-top:20px; display:none; }
.res-item { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:16px 20px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:all .2s; }
.res-item:hover { border-color:rgba(79,142,247,0.4); transform:translateY(-1px); box-shadow:0 4px 20px rgba(0,0,0,0.3); }
.res-item h4 { font-family:'Syne',sans-serif; font-weight:600; font-size:0.95rem; margin-bottom:3px; }
.res-item p { font-size:0.78rem; color:var(--text-dim); font-family:'JetBrains Mono',monospace; }
.pagination-bar { display:flex; align-items:center; justify-content:center; gap:10px; margin-top:16px; }
.pg-info { font-family:'JetBrains Mono',monospace; font-size:0.75rem; color:var(--text-muted); }

/* ‚îÄ‚îÄ PROFILE SCREEN ‚îÄ‚îÄ */
#profileScreen { display:none; max-width:1060px; margin:0 auto; padding:32px 24px 80px; }

.back-btn { display:inline-flex; align-items:center; gap:7px; color:var(--text-dim); font-size:0.85rem; cursor:pointer; margin-bottom:24px; border:none; background:none; transition:color .2s; padding:0; }
.back-btn:hover { color:var(--accent2); }

/* Profile header */
.profile-header {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 28px 32px;
  margin-bottom: 24px;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 20px;
  align-items: start;
}
.profile-header h2 { font-family:'Syne',sans-serif; font-size:clamp(1.3rem,3vw,1.9rem); font-weight:800; letter-spacing:-0.03em; line-height:1.2; margin-bottom:10px; }
.profile-chips { display:flex; flex-wrap:wrap; gap:7px; margin-bottom:14px; }
.chip { font-family:'JetBrains Mono',monospace; font-size:0.68rem; padding:3px 9px; border-radius:6px; background:var(--surface2); border:1px solid var(--border2); color:var(--text-dim); }
.chip.blue { color:var(--accent2); border-color:rgba(79,142,247,0.3); background:rgba(79,142,247,0.08); }
.chip.green { color:var(--green); border-color:rgba(14,201,127,0.3); background:rgba(14,201,127,0.08); }
.chip.gold { color:var(--gold); border-color:rgba(240,180,41,0.3); background:rgba(240,180,41,0.08); }
.chip.red { color:var(--red); border-color:rgba(240,97,74,0.3); background:rgba(240,97,74,0.08); }
.profile-meta { display:flex; flex-wrap:wrap; gap:16px; font-size:0.82rem; color:var(--text-dim); }
.profile-right { display:flex; flex-direction:column; align-items:flex-end; gap:10px; }
.estado-big { font-family:'JetBrains Mono',monospace; font-size:0.75rem; font-weight:700; padding:6px 14px; border-radius:20px; text-transform:uppercase; letter-spacing:0.06em; }
.e-Activo { background:rgba(14,201,127,0.12); color:var(--green); border:1px solid rgba(14,201,127,0.3); }
.e-Inactivo { background:rgba(240,97,74,0.1); color:var(--red); border:1px solid rgba(240,97,74,0.25); }
.e-Desactualizado { background:rgba(240,180,41,0.1); color:var(--gold); border:1px solid rgba(240,180,41,0.25); }
.rpe-big { font-family:'JetBrains Mono',monospace; font-size:0.78rem; color:var(--text-muted); }
.cert-link { font-size:0.78rem; color:var(--accent2); text-decoration:none; }
.cert-link:hover { text-decoration:underline; }

/* Tabs */
.tabs { display:flex; gap:4px; margin-bottom:20px; background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:5px; flex-wrap:wrap; }
.tab-btn {
  padding:9px 18px; border-radius:10px; border:none; cursor:pointer;
  font-family:'Inter',sans-serif; font-weight:500; font-size:0.83rem;
  color:var(--text-muted); background:none; transition:all .2s;
  display:flex; align-items:center; gap:6px;
}
.tab-btn:hover { color:var(--text-dim); }
.tab-btn.active { background:var(--surface3); color:var(--accent2); border:1px solid rgba(79,142,247,0.25); }
.tab-btn .count { font-family:'JetBrains Mono',monospace; font-size:0.65rem; background:rgba(79,142,247,0.15); color:var(--accent); padding:1px 6px; border-radius:10px; }

/* Tab panels */
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* Summary cards */
.summary-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin-bottom:24px; }
.sum-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:20px; }
.sum-card .val { font-family:'Syne',sans-serif; font-size:1.8rem; font-weight:800; letter-spacing:-0.03em; margin-bottom:4px; }
.sum-card .val.accent { color:var(--accent2); }
.sum-card .val.gold { color:var(--gold); }
.sum-card .val.green { color:var(--green); }
.sum-card .val.purple { color:var(--purple); }
.sum-card .lbl { font-size:0.78rem; color:var(--text-muted); font-weight:500; }

/* Table */
.table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
.table-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.table-header h3 { font-family:'Syne',sans-serif; font-size:0.95rem; font-weight:700; }
.table-header span { font-family:'JetBrains Mono',monospace; font-size:0.72rem; color:var(--text-muted); }
table { width:100%; border-collapse:collapse; font-size:0.82rem; }
th { text-align:left; padding:11px 16px; font-family:'JetBrains Mono',monospace; font-size:0.67rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em; border-bottom:1px solid var(--border); font-weight:500; }
td { padding:12px 16px; border-bottom:1px solid rgba(36,48,80,0.5); color:var(--text-dim); vertical-align:top; }
tr:last-child td { border-bottom:none; }
tr:hover td { background:rgba(79,142,247,0.03); }
td.mono { font-family:'JetBrains Mono',monospace; font-size:0.78rem; }
td strong { color:var(--text); font-weight:500; }
.amount { font-family:'JetBrains Mono',monospace; color:var(--gold); font-size:0.8rem; }
.tag { display:inline-block; font-family:'JetBrains Mono',monospace; font-size:0.65rem; padding:2px 7px; border-radius:5px; }
.tag-green { background:rgba(14,201,127,0.12); color:var(--green); }
.tag-blue { background:rgba(79,142,247,0.12); color:var(--accent2); }
.tag-red { background:rgba(240,97,74,0.1); color:var(--red); }
.tag-gold { background:rgba(240,180,41,0.1); color:var(--gold); }
.tag-gray { background:rgba(77,106,153,0.2); color:var(--text-muted); }

/* Pagination in panels */
.panel-pagination { display:flex; align-items:center; justify-content:center; gap:10px; padding:16px; border-top:1px solid var(--border); }

/* Loading / empty */
.loading-state { text-align:center; padding:48px 20px; }
.spinner { width:32px; height:32px; border:2px solid var(--border2); border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 12px; }
.loading-state p { color:var(--text-muted); font-size:0.85rem; }
.empty-state { text-align:center; padding:48px 20px; color:var(--text-muted); font-size:0.88rem; }
.empty-state .icon { font-size:2.5rem; margin-bottom:10px; opacity:.5; }

/* Detail row expandable */
.detail-row td { padding:0; }
.detail-inner { padding:14px 16px 14px 32px; background:var(--surface2); font-size:0.8rem; color:var(--text-dim); }
.detail-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px; }
.detail-item label { display:block; font-family:'JetBrains Mono',monospace; font-size:0.63rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.07em; margin-bottom:3px; }
.detail-item span { color:var(--text-dim); }
.expand-btn { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:0.8rem; padding:2px 6px; border-radius:4px; transition:color .2s; }
.expand-btn:hover { color:var(--accent2); }

@keyframes spin { to { transform:rotate(360deg); } }

@media(max-width:640px) {
  header { padding:12px 16px; }
  #searchScreen, #profileScreen { padding: 32px 14px; }
  .profile-header { grid-template-columns:1fr; }
  .profile-right { flex-direction:row; align-items:center; flex-wrap:wrap; }
  .tabs { gap:3px; }
  .tab-btn { padding:8px 12px; font-size:0.78rem; }
  table { font-size:0.75rem; }
  th, td { padding:9px 10px; }
}
</style>
</head>
<body>

<header>
  <div class="logo">üèõÔ∏è</div>
  <h1>DGCP <span>Consulta</span></h1>
  <div class="hbadge">DATOS ABIERTOS RD</div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEARCH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="searchScreen">
  <div class="search-hero">
    <h2>Consulta <em>proveedores</em><br>del Estado</h2>
    <p>Contratos ¬∑ Ofertas ¬∑ Sentencias SCJ ¬∑ Audiencias Judiciales</p>
  </div>

  <div class="search-card">
    <label>Nombre de empresa / raz√≥n social</label>
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="Ej: Constructora Nacional, SRL...">
      <button class="btn btn-primary" onclick="doSearch(1)">Buscar</button>
    </div>
    <div class="search-hints">
      <span style="font-size:.75rem;color:var(--text-muted);align-self:center">Ejemplos:</span>
      <span class="hint" onclick="quickSearch('Cata Multiservices')">Cata Multiservices <span>¬∑</span> RPE 113380</span>
      <span class="hint" onclick="quickSearch('constructora')">Constructoras</span>
      <span class="hint" onclick="quickSearch('farmacia')">Farmacias</span>
    </div>
  </div>

  <div id="resultsList">
    <div id="resultsItems"></div>
    <div class="pagination-bar" id="searchPagination"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="profileScreen">
  <button class="back-btn" onclick="goBack()">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Volver a resultados
  </button>

  <div class="profile-header" id="profileHeader">
    <div class="loading-state"><div class="spinner"></div></div>
  </div>

  <div class="tabs" id="tabsBar">
    <button class="tab-btn active" onclick="showTab('resumen')" id="tab-resumen">üìä Resumen</button>
    <button class="tab-btn" onclick="showTab('contratos')" id="tab-contratos">üìÑ Contratos</button>
    <button class="tab-btn" onclick="showTab('ofertas')" id="tab-ofertas">üìã Ofertas</button>
    <button class="tab-btn" onclick="showTab('resoluciones')" id="tab-resoluciones">‚öñÔ∏è Resoluciones DGCP</button>
    <button class="tab-btn" onclick="showTab('sentencias')" id="tab-sentencias">üèõÔ∏è Sentencias SCJ</button>
    <button class="tab-btn" onclick="showTab('audiencias')" id="tab-audiencias">üîî Audiencias</button>
  </div>

  <div id="tab-resumen-panel" class="tab-panel active"></div>
  <div id="tab-contratos-panel" class="tab-panel"></div>
  <div id="tab-ofertas-panel" class="tab-panel"></div>
  <div id="tab-resoluciones-panel" class="tab-panel"></div>
  <div id="tab-sentencias-panel" class="tab-panel"></div>
  <div id="tab-audiencias-panel" class="tab-panel"></div>
</div>

<script>
const DGCP = 'https://datosabiertos.dgcp.gob.do/api-dgcp/v1';
const CIVIC = 'https://civiceye-production.up.railway.app';

let currentRPE = null;
let currentRNC = null;
let currentName = null;
let searchPage = 1;
let contractPage = 1;
let loadedTabs = {};

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ
function fmt(n) {
  if (n == null || n === '' || n === undefined) return '‚Äî';
  return n;
}
function fmtDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('es-DO', { year:'numeric', month:'short', day:'numeric' });
}
function fmtMoney(v, cur) {
  if (v == null) return '‚Äî';
  const n = parseFloat(v);
  if (isNaN(n)) return v;
  return n.toLocaleString('es-DO', { minimumFractionDigits:2, maximumFractionDigits:2 }) + (cur ? ' ' + cur : '');
}
function estadoTag(e) {
  const m = { 'Activo':'tag-green','Activa':'tag-green','Inactivo':'tag-red','Inactiva':'tag-red','Desactualizado':'tag-gold' };
  return `<span class="tag ${m[e]||'tag-gray'}">${e||'‚Äî'}</span>`;
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
function quickSearch(q) {
  document.getElementById('searchInput').value = q;
  doSearch(1);
}

async function doSearch(page) {
  searchPage = page;
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;
  const limit = 10;
  const el = document.getElementById('resultsList');
  const items = document.getElementById('resultsItems');
  el.style.display = 'block';
  items.innerHTML = `<div class="loading-state"><div class="spinner"></div><p>Buscando...</p></div>`;
  document.getElementById('searchPagination').innerHTML = '';

  try {
    const res = await fetch(`${DGCP}/proveedores?page=${page}&limit=${limit}&razon_social=${encodeURIComponent(q)}`);
    const data = await res.json();
    const list = data.payload?.content;
    if (!list?.length) {
      items.innerHTML = `<div class="empty-state"><div class="icon">üîç</div>No se encontraron resultados.</div>`;
      return;
    }
    const total = data.totalResults || 0;
    const pages = data.pages || 1;

    items.innerHTML = list.map(p => {
      const ec = `e-${(p.estado||'Inactivo').replace(/\s/g,'')}`;
      return `<div class="res-item" onclick="loadProfile(${p.rpe},'${encodeURIComponent(p.razon_social)}','${p.numero_documento}')">
        <div>
          <h4>${p.razon_social}</h4>
          <p>${p.tipo_documento}: ${p.numero_documento} ¬∑ RPE ${p.rpe} ¬∑ ${p.municipio||p.provincia||'RD'}</p>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <span class="estado-big ${ec}" style="font-family:'JetBrains Mono',monospace;font-size:.68rem;font-weight:700;padding:3px 10px;border-radius:20px;text-transform:uppercase;letter-spacing:.06em">${p.estado||'‚Äî'}</span>
          <span style="font-size:.72rem;color:var(--text-muted)">‚Üí Ver perfil</span>
        </div>
      </div>`;
    }).join('');

    // pagination
    if (pages > 1) {
      document.getElementById('searchPagination').innerHTML = `
        <button class="btn btn-ghost btn-sm" ${page<=1?'disabled':''} onclick="doSearch(${page-1})">‚Üê</button>
        <span class="pg-info">${page} / ${pages} ¬∑ ${total.toLocaleString('es-DO')} resultados</span>
        <button class="btn btn-ghost btn-sm" ${page>=pages?'disabled':''} onclick="doSearch(${page+1})">‚Üí</button>`;
    }
  } catch(e) {
    items.innerHTML = `<div class="empty-state">‚ö†Ô∏è Error: ${e.message}</div>`;
  }
}

document.getElementById('searchInput').addEventListener('keydown', e => { if(e.key==='Enter') doSearch(1); });

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
function goBack() {
  document.getElementById('profileScreen').style.display = 'none';
  document.getElementById('searchScreen').style.display = 'block';
}

async function loadProfile(rpe, nameEnc, rnc) {
  currentRPE = rpe;
  currentRNC = rnc;
  currentName = decodeURIComponent(nameEnc);
  loadedTabs = {};

  document.getElementById('searchScreen').style.display = 'none';
  document.getElementById('profileScreen').style.display = 'block';
  document.getElementById('profileHeader').innerHTML = `<div class="loading-state"><div class="spinner"></div><p>Cargando perfil...</p></div>`;

  // Reset tabs
  showTab('resumen');
  ['contratos','ofertas','resoluciones','sentencias','audiencias'].forEach(t => {
    document.getElementById(`tab-${t}-panel`).innerHTML = '';
    const btn = document.getElementById(`tab-${t}`);
    btn.innerHTML = btn.innerHTML.replace(/<span class="count">.*<\/span>/,'').trim();
  });

  // Load profile info
  try {
    const res = await fetch(`${DGCP}/proveedores?rpe=${rpe}`);
    const data = await res.json();
    const p = data.payload?.content?.[0];
    if (!p) { document.getElementById('profileHeader').innerHTML = `<div class="empty-state">No se encontr√≥ el perfil.</div>`; return; }
    renderProfileHeader(p);
    loadTab('resumen');
  } catch(e) {
    document.getElementById('profileHeader').innerHTML = `<div class="empty-state">‚ö†Ô∏è Error: ${e.message}</div>`;
  }
}

function renderProfileHeader(p) {
  const ec = `e-${(p.estado||'Inactivo').replace(/\s/g,'')}`;
  document.getElementById('profileHeader').innerHTML = `
    <div>
      <h2>${p.razon_social}</h2>
      <div class="profile-chips">
        <span class="chip blue">${p.tipo_documento}: ${p.numero_documento}</span>
        <span class="chip">${p.forma_juridica||'‚Äî'}</span>
        ${p.es_mipyme==='Si' ? `<span class="chip green">MIPYME ‚úì</span>` : ''}
        ${p.certificacion_micm==='Si' ? `<span class="chip gold">Cert. MICM</span>` : ''}
        ${p.productor_nacional==='Si' ? `<span class="chip green">Productor Nacional</span>` : ''}
        ${p.clasificacion && p.clasificacion!=='No clasificada' ? `<span class="chip">${p.clasificacion}</span>` : ''}
      </div>
      <div class="profile-meta">
        ${p.direccion ? `<span>üìç ${p.direccion}</span>` : ''}
        ${p.telefono_comercial ? `<span>üìû ${p.telefono_comercial}</span>` : ''}
        ${p.correo_comercial ? `<span>‚úâÔ∏è ${p.correo_comercial}</span>` : ''}
        ${p.provee ? `<span>üì¶ ${p.provee}</span>` : ''}
        ${p.fecha_creacion_empresa ? `<span>üìÖ Fundada ${new Date(p.fecha_creacion_empresa).getFullYear()}</span>` : ''}
      </div>
      ${p.contacto ? `<div style="margin-top:12px;font-size:.8rem;color:var(--text-muted)">Contacto: <span style="color:var(--text-dim)">${p.contacto} ¬∑ ${p.posicion_contacto||''} ¬∑ ${p.telefono_contacto||''}</span></div>` : ''}
    </div>
    <div class="profile-right">
      <span class="estado-big ${ec}">${p.estado||'‚Äî'}</span>
      <span class="rpe-big">RPE #${p.rpe}</span>
      ${p.url_certificacion ? `<a href="${p.url_certificacion}" target="_blank" class="cert-link">‚Üì Constancia</a>` : ''}
    </div>`;
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function showTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  document.getElementById(`tab-${name}-panel`).classList.add('active');
  if (!loadedTabs[name]) { loadTab(name); }
}

function loadTab(name) {
  loadedTabs[name] = true;
  const fns = { resumen: loadResumen, contratos: loadContratos, ofertas: loadOfertas, resoluciones: loadResoluciones, sentencias: loadSentencias, audiencias: loadAudiencias };
  if (fns[name]) fns[name]();
}

function panelLoading(id) {
  document.getElementById(`tab-${id}-panel`).innerHTML = `<div class="loading-state"><div class="spinner"></div><p>Cargando datos...</p></div>`;
}

function setTabCount(id, n) {
  const btn = document.getElementById(`tab-${id}`);
  const existing = btn.querySelector('.count');
  if (existing) existing.remove();
  if (n > 0) btn.innerHTML += ` <span class="count">${n}</span>`;
}

// ‚îÄ‚îÄ RESUMEN ‚îÄ‚îÄ
async function loadResumen() {
  panelLoading('resumen');
  const panel = document.getElementById('tab-resumen-panel');
  try {
    const [contRes, ofRes] = await Promise.allSettled([
      fetch(`${DGCP}/contratos?limit=1000&page=1&rpe=${currentRPE}`).then(r=>r.json()),
      fetch(`${DGCP}/ofertas?limit=10000&rpe=${currentRPE}`).then(r=>r.json())
    ]);

    const contratos = contRes.status==='fulfilled' ? (contRes.value.payload?.content||[]) : [];
    const ofertas = ofRes.status==='fulfilled' ? (ofRes.value.payload?.content||[]) : [];

    // calc totals
    const totalContratos = contRes.status==='fulfilled' ? (contRes.value.totalResults||contratos.length) : 0;
    const totalOfertas = ofertas.length;

    let totalMonto = 0;
    contratos.forEach(c => { const v = parseFloat(c.monto_contrato||c.monto||0); if(!isNaN(v)) totalMonto += v; });

    let monedas = {};
    contratos.forEach(c => { const mon = c.moneda||'RD$'; monedas[mon] = (monedas[mon]||0) + 1; });
    const monedaPrincipal = Object.keys(monedas).sort((a,b)=>monedas[b]-monedas[a])[0] || 'RD$';

    // institutions
    let instCount = {};
    contratos.forEach(c => { const inst = c.nombre_institucion||c.institucion; if(inst) instCount[inst]=(instCount[inst]||0)+1; });
    const topInst = Object.entries(instCount).sort((a,b)=>b[1]-a[1]).slice(0,5);

    // years
    let byYear = {};
    contratos.forEach(c => {
      const yr = c.fecha_contrato ? new Date(c.fecha_contrato).getFullYear() : null;
      if (yr) byYear[yr] = (byYear[yr]||0)+1;
    });
    const years = Object.entries(byYear).sort((a,b)=>b[0]-a[0]);

    panel.innerHTML = `
      <div class="summary-grid">
        <div class="sum-card">
          <div class="val accent">${totalContratos.toLocaleString('es-DO')}</div>
          <div class="lbl">Contratos adjudicados</div>
        </div>
        <div class="sum-card">
          <div class="val gold">${fmtMoney(totalMonto, monedaPrincipal)}</div>
          <div class="lbl">Monto total contratado</div>
        </div>
        <div class="sum-card">
          <div class="val green">${totalOfertas.toLocaleString('es-DO')}</div>
          <div class="lbl">Ofertas presentadas</div>
        </div>
        <div class="sum-card">
          <div class="val purple">${topInst.length > 0 ? Object.keys(instCount).length : '‚Äî'}</div>
          <div class="lbl">Instituciones contratantes</div>
        </div>
      </div>
      ${topInst.length ? `
      <div class="table-wrap" style="margin-bottom:16px">
        <div class="table-header"><h3>Top Instituciones Contratantes</h3></div>
        <table>
          <thead><tr><th>#</th><th>Instituci√≥n</th><th>Contratos</th></tr></thead>
          <tbody>${topInst.map((([k,v],i)=>`<tr><td class="mono">${i+1}</td><td><strong>${k}</strong></td><td class="mono">${v}</td></tr>`)).join('')}</tbody>
        </table>
      </div>` : ''}
      ${years.length ? `
      <div class="table-wrap">
        <div class="table-header"><h3>Contratos por A√±o</h3></div>
        <table>
          <thead><tr><th>A√±o</th><th>Cantidad</th><th>Distribuci√≥n</th></tr></thead>
          <tbody>${years.map(([yr,cnt])=>{
            const pct = Math.round((cnt/totalContratos)*100);
            return `<tr>
              <td class="mono">${yr}</td>
              <td class="mono">${cnt}</td>
              <td><div style="display:flex;align-items:center;gap:8px">
                <div style="height:6px;width:${Math.max(pct*2,4)}px;background:var(--accent);border-radius:3px;opacity:.7"></div>
                <span style="font-size:.75rem;color:var(--text-muted)">${pct}%</span>
              </div></td>
            </tr>`;
          }).join('')}</tbody>
        </table>
      </div>` : ''}`;
  } catch(e) {
    panel.innerHTML = `<div class="empty-state">‚ö†Ô∏è Error cargando resumen: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ CONTRATOS ‚îÄ‚îÄ
async function loadContratos(page=1) {
  panelLoading('contratos');
  const panel = document.getElementById('tab-contratos-panel');
  try {
    const res = await fetch(`${DGCP}/contratos?limit=20&page=${page}&rpe=${currentRPE}`);
    const data = await res.json();
    const list = data.payload?.content || [];
    const total = data.totalResults || 0;
    const pages = data.pages || 1;

    setTabCount('contratos', total);

    if (!list.length) { panel.innerHTML = `<div class="empty-state"><div class="icon">üìÑ</div>Sin contratos registrados.</div>`; return; }

    panel.innerHTML = `
      <div class="table-wrap">
        <div class="table-header">
          <h3>Contratos Adjudicados</h3>
          <span>${total.toLocaleString('es-DO')} contratos</span>
        </div>
        <div style="overflow-x:auto">
        <table>
          <thead><tr><th></th><th>Proceso / Descripci√≥n</th><th>Instituci√≥n</th><th>Monto</th><th>Fecha</th><th>Tipo</th></tr></thead>
          <tbody id="contratosBody"></tbody>
        </table>
        </div>
        <div class="panel-pagination" id="contratosPag"></div>
      </div>`;

    const tbody = document.getElementById('contratosBody');
    tbody.innerHTML = list.map((c,i) => {
      const id = `cr-${i}`;
      return `
        <tr>
          <td><button class="expand-btn" onclick="toggleDetail('${id}')">‚ñ∏</button></td>
          <td><strong>${fmt(c.descripcion||c.nombre_proceso||c.proceso)}</strong><br><span style="font-size:.72rem;color:var(--text-muted)">${fmt(c.numero_contrato||c.referencia)}</span></td>
          <td style="font-size:.78rem">${fmt(c.nombre_institucion||c.institucion)}</td>
          <td class="amount">${fmtMoney(c.monto_contrato||c.monto, c.moneda)}</td>
          <td class="mono" style="font-size:.75rem">${fmtDate(c.fecha_contrato||c.fecha)}</td>
          <td>${c.tipo_compra||c.modalidad ? `<span class="tag tag-blue">${c.tipo_compra||c.modalidad}</span>` : '‚Äî'}</td>
        </tr>
        <tr id="${id}" style="display:none" class="detail-row">
          <td colspan="6">
            <div class="detail-inner">
              <div class="detail-grid">
                ${Object.entries(c).filter(([k,v])=>v!=null&&v!=='').slice(0,12).map(([k,v])=>`
                  <div class="detail-item"><label>${k.replace(/_/g,' ')}</label><span>${typeof v==='string'&&v.startsWith('http') ? `<a href="${v}" target="_blank" style="color:var(--accent2)">${v.substring(0,40)}‚Ä¶</a>` : v}</span></div>
                `).join('')}
              </div>
            </div>
          </td>
        </tr>`;
    }).join('');

    if (pages > 1) {
      document.getElementById('contratosPag').innerHTML = `
        <button class="btn btn-ghost btn-sm" ${page<=1?'disabled':''} onclick="loadContratos(${page-1})">‚Üê</button>
        <span class="pg-info">${page} / ${pages}</span>
        <button class="btn btn-ghost btn-sm" ${page>=pages?'disabled':''} onclick="loadContratos(${page+1})">‚Üí</button>`;
    }
  } catch(e) {
    panel.innerHTML = `<div class="empty-state">‚ö†Ô∏è Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ OFERTAS ‚îÄ‚îÄ
async function loadOfertas() {
  panelLoading('ofertas');
  const panel = document.getElementById('tab-ofertas-panel');
  try {
    const res = await fetch(`${DGCP}/ofertas?limit=500&rpe=${currentRPE}`);
    const data = await res.json();
    const list = data.payload?.content || [];
    const total = data.totalResults || list.length;

    setTabCount('ofertas', total);

    if (!list.length) { panel.innerHTML = `<div class="empty-state"><div class="icon">üìã</div>Sin ofertas registradas.</div>`; return; }

    // Stats
    const ganadas = list.filter(o => o.estado_oferta?.toLowerCase().includes('adjudicad')||o.adjudicado===true||o.ganador===true).length;
    const pctGanado = total > 0 ? Math.round((ganadas/total)*100) : 0;

    panel.innerHTML = `
      <div class="summary-grid" style="margin-bottom:16px">
        <div class="sum-card"><div class="val accent">${total.toLocaleString('es-DO')}</div><div class="lbl">Total ofertas</div></div>
        <div class="sum-card"><div class="val green">${ganadas.toLocaleString('es-DO')}</div><div class="lbl">Adjudicadas</div></div>
        <div class="sum-card"><div class="val gold">${pctGanado}%</div><div class="lbl">Tasa de √©xito</div></div>
      </div>
      <div class="table-wrap">
        <div class="table-header"><h3>Ofertas Presentadas</h3><span>${total.toLocaleString('es-DO')} total</span></div>
        <div style="overflow-x:auto">
        <table>
          <thead><tr><th></th><th>Proceso</th><th>Instituci√≥n</th><th>Monto Ofertado</th><th>Fecha</th><th>Estado</th></tr></thead>
          <tbody>${list.slice(0,200).map((o,i)=>{
            const id=`of-${i}`;
            const est = o.estado_oferta||o.estado||'‚Äî';
            const isWon = est.toLowerCase().includes('adjudicad')||o.adjudicado===true;
            return `
              <tr>
                <td><button class="expand-btn" onclick="toggleDetail('${id}')">‚ñ∏</button></td>
                <td><strong>${fmt(o.descripcion||o.nombre_proceso||o.proceso)}</strong><br><span style="font-size:.72rem;color:var(--text-muted)">${fmt(o.numero_proceso||o.referencia)}</span></td>
                <td style="font-size:.78rem">${fmt(o.nombre_institucion||o.institucion)}</td>
                <td class="amount">${fmtMoney(o.monto_ofertado||o.monto, o.moneda)}</td>
                <td class="mono" style="font-size:.75rem">${fmtDate(o.fecha_apertura||o.fecha)}</td>
                <td><span class="tag ${isWon?'tag-green':'tag-gray'}">${est}</span></td>
              </tr>
              <tr id="${id}" style="display:none" class="detail-row">
                <td colspan="6"><div class="detail-inner"><div class="detail-grid">
                  ${Object.entries(o).filter(([k,v])=>v!=null&&v!=='').slice(0,10).map(([k,v])=>`<div class="detail-item"><label>${k.replace(/_/g,' ')}</label><span>${v}</span></div>`).join('')}
                </div></div></td>
              </tr>`;
          }).join('')}</tbody>
        </table>
        </div>
      </div>`;
  } catch(e) {
    panel.innerHTML = `<div class="empty-state">‚ö†Ô∏è Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ RESOLUCIONES DGCP ‚îÄ‚îÄ
async function loadResoluciones(skip=0) {
  panelLoading('resoluciones');
  const panel = document.getElementById('tab-resoluciones-panel');
  const limit = 10;
  try {
    const res = await fetch(`${CIVIC}/dgcp_resolutions?skip=${skip}&limit=${limit}&rpe=${currentRPE}`);
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.data||data.results||data.items||[]);
    const total = data.total || data.count || list.length;

    setTabCount('resoluciones', total);

    if (!list.length) { panel.innerHTML = `<div class="empty-state"><div class="icon">‚öñÔ∏è</div>Sin resoluciones DGCP registradas.</div>`; return; }

    panel.innerHTML = `
      <div class="table-wrap">
        <div class="table-header"><h3>Resoluciones DGCP</h3><span>${total} registros</span></div>
        <div style="overflow-x:auto">
        <table>
          <thead><tr><th></th><th>Resoluci√≥n</th><th>Descripci√≥n</th><th>Fecha</th><th>Estado</th></tr></thead>
          <tbody>${list.map((r,i)=>{
            const id=`res-${i}`;
            return `
              <tr>
                <td><button class="expand-btn" onclick="toggleDetail('${id}')">‚ñ∏</button></td>
                <td class="mono" style="font-size:.75rem"><strong>${fmt(r.numero_resolucion||r.resolucion||r.numero||r.id)}</strong></td>
                <td>${fmt(r.descripcion||r.asunto||r.motivo||r.tipo)}</td>
                <td class="mono" style="font-size:.75rem">${fmtDate(r.fecha||r.fecha_resolucion||r.created_at)}</td>
                <td>${r.estado ? estadoTag(r.estado) : '‚Äî'}</td>
              </tr>
              <tr id="${id}" style="display:none" class="detail-row">
                <td colspan="5"><div class="detail-inner"><div class="detail-grid">
                  ${Object.entries(r).filter(([k,v])=>v!=null&&v!=='').slice(0,12).map(([k,v])=>`<div class="detail-item"><label>${k.replace(/_/g,' ')}</label><span>${typeof v==='string'&&v.startsWith('http')?`<a href="${v}" target="_blank" style="color:var(--accent2)">Ver documento</a>`:v}</span></div>`).join('')}
                </div></div></td>
              </tr>`;
          }).join('')}</tbody>
        </table>
        </div>
        <div class="panel-pagination">
          <button class="btn btn-ghost btn-sm" ${skip<=0?'disabled':''} onclick="loadResoluciones(${Math.max(0,skip-limit)})">‚Üê</button>
          <span class="pg-info">Mostrando ${skip+1}‚Äì${Math.min(skip+limit,total)} de ${total}</span>
          <button class="btn btn-ghost btn-sm" ${skip+limit>=total?'disabled':''} onclick="loadResoluciones(${skip+limit})">‚Üí</button>
        </div>
      </div>`;
  } catch(e) {
    panel.innerHTML = `<div class="empty-state">‚ö†Ô∏è Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ SENTENCIAS SCJ ‚îÄ‚îÄ
async function loadSentencias(start=0) {
  panelLoading('sentencias');
  const panel = document.getElementById('tab-sentencias-panel');
  const length = 10;
  try {
    const res = await fetch(`${CIVIC}/judicial-cases/?search=${currentRNC}&start=${start}&length=${length}`);
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.data||data.results||data.items||[]);
    const total = data.recordsTotal || data.total || data.count || list.length;

    setTabCount('sentencias', total);

    if (!list.length) { panel.innerHTML = `<div class="empty-state"><div class="icon">üèõÔ∏è</div>Sin sentencias SCJ registradas para RNC ${currentRNC}.</div>`; return; }

    panel.innerHTML = `
      <div class="table-wrap">
        <div class="table-header"><h3>Sentencias Suprema Corte de Justicia</h3><span>${total} registros</span></div>
        <div style="overflow-x:auto">
        <table>
          <thead><tr><th></th><th>Expediente / Caso</th><th>Materia</th><th>Fecha</th><th>Resultado</th></tr></thead>
          <tbody>${list.map((s,i)=>{
            const id=`scj-${i}`;
            return `
              <tr>
                <td><button class="expand-btn" onclick="toggleDetail('${id}')">‚ñ∏</button></td>
                <td class="mono" style="font-size:.75rem"><strong>${fmt(s.numero_expediente||s.expediente||s.caso||s.id)}</strong></td>
                <td>${fmt(s.materia||s.tipo||s.asunto||s.descripcion)}</td>
                <td class="mono" style="font-size:.75rem">${fmtDate(s.fecha||s.fecha_sentencia||s.date||s.created_at)}</td>
                <td>${s.resultado||s.decision||s.fallo ? `<span class="tag tag-blue">${s.resultado||s.decision||s.fallo}</span>` : '‚Äî'}</td>
              </tr>
              <tr id="${id}" style="display:none" class="detail-row">
                <td colspan="5"><div class="detail-inner"><div class="detail-grid">
                  ${Object.entries(s).filter(([k,v])=>v!=null&&v!=='').slice(0,12).map(([k,v])=>`<div class="detail-item"><label>${k.replace(/_/g,' ')}</label><span>${typeof v==='string'&&v.startsWith('http')?`<a href="${v}" target="_blank" style="color:var(--accent2)">Ver documento</a>`:v}</span></div>`).join('')}
                </div></div></td>
              </tr>`;
          }).join('')}</tbody>
        </table>
        </div>
        <div class="panel-pagination">
          <button class="btn btn-ghost btn-sm" ${start<=0?'disabled':''} onclick="loadSentencias(${Math.max(0,start-length)})">‚Üê</button>
          <span class="pg-info">Mostrando ${start+1}‚Äì${Math.min(start+length,total)} de ${total}</span>
          <button class="btn btn-ghost btn-sm" ${start+length>=total?'disabled':''} onclick="loadSentencias(${start+length})">‚Üí</button>
        </div>
      </div>`;
  } catch(e) {
    panel.innerHTML = `<div class="empty-state">‚ö†Ô∏è Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ AUDIENCIAS JUDICIALES ‚îÄ‚îÄ
async function loadAudiencias(page=1) {
  panelLoading('audiencias');
  const panel = document.getElementById('tab-audiencias-panel');
  const pageSize = 20;
  try {
    const res = await fetch(`${CIVIC}/judicial_power/?page=${page}&page_size=${pageSize}&identifier=${currentRNC}`);
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.data||data.results||data.items||[]);
    const total = data.total || data.count || list.length;
    const pages = Math.ceil(total / pageSize) || 1;

    setTabCount('audiencias', total);

    if (!list.length) { panel.innerHTML = `<div class="empty-state"><div class="icon">üîî</div>Sin audiencias judiciales registradas para RNC ${currentRNC}.</div>`; return; }

    panel.innerHTML = `
      <div class="table-wrap">
        <div class="table-header"><h3>Audiencias Judiciales</h3><span>${total} registros</span></div>
        <div style="overflow-x:auto">
        <table>
          <thead><tr><th></th><th>Expediente</th><th>Juzgado / Tribunal</th><th>Materia</th><th>Fecha Audiencia</th><th>Estado</th></tr></thead>
          <tbody>${list.map((a,i)=>{
            const id=`aud-${i}`;
            return `
              <tr>
                <td><button class="expand-btn" onclick="toggleDetail('${id}')">‚ñ∏</button></td>
                <td class="mono" style="font-size:.75rem"><strong>${fmt(a.numero_expediente||a.expediente||a.caso||a.id)}</strong></td>
                <td style="font-size:.78rem">${fmt(a.tribunal||a.juzgado||a.organo||a.corte)}</td>
                <td>${fmt(a.materia||a.tipo||a.asunto)}</td>
                <td class="mono" style="font-size:.75rem">${fmtDate(a.fecha_audiencia||a.fecha||a.date)}</td>
                <td>${a.estado ? estadoTag(a.estado) : '‚Äî'}</td>
              </tr>
              <tr id="${id}" style="display:none" class="detail-row">
                <td colspan="6"><div class="detail-inner"><div class="detail-grid">
                  ${Object.entries(a).filter(([k,v])=>v!=null&&v!=='').slice(0,12).map(([k,v])=>`<div class="detail-item"><label>${k.replace(/_/g,' ')}</label><span>${v}</span></div>`).join('')}
                </div></div></td>
              </tr>`;
          }).join('')}</tbody>
        </table>
        </div>
        <div class="panel-pagination">
          <button class="btn btn-ghost btn-sm" ${page<=1?'disabled':''} onclick="loadAudiencias(${page-1})">‚Üê</button>
          <span class="pg-info">${page} / ${pages} ¬∑ ${total} registros</span>
          <button class="btn btn-ghost btn-sm" ${page>=pages?'disabled':''} onclick="loadAudiencias(${page+1})">‚Üí</button>
        </div>
      </div>`;
  } catch(e) {
    panel.innerHTML = `<div class="empty-state">‚ö†Ô∏è Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function toggleDetail(id) {
  const row = document.getElementById(id);
  const btn = row.previousElementSibling.querySelector('.expand-btn');
  if (row.style.display === 'none') {
    row.style.display = 'table-row';
    if (btn) btn.textContent = '‚ñæ';
  } else {
    row.style.display = 'none';
    if (btn) btn.textContent = '‚ñ∏';
  }
}
</script>
</body>
</html>
