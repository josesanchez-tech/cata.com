<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGCP ‚Äî Consulta de Proveedores</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07090f; --surface:#0f1420; --surface2:#161d2e; --surface3:#1e2740;
  --border:#243050; --border2:#2e3d60;
  --accent:#4f8ef7; --accent2:#7eb0ff;
  --gold:#f0b429; --green:#0ec97f; --red:#f0614a; --purple:#a78bfa;
  --text:#dce7ff; --text-dim:#8da3cc; --text-muted:#4d6a99;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;
  background-image:radial-gradient(ellipse 80% 40% at 50% -10%,rgba(79,142,247,.12) 0%,transparent 70%);}

/* HEADER */
header{display:flex;align-items:center;gap:14px;padding:16px 32px;border-bottom:1px solid var(--border);
  background:rgba(7,9,15,.92);backdrop-filter:blur(12px);position:sticky;top:0;z-index:300;}
.logo{width:32px;height:32px;background:linear-gradient(135deg,#4f8ef7,#f0b429);border-radius:7px;
  display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
header h1{font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:700;letter-spacing:-.02em;}
header h1 span{color:var(--accent2);}
.hbadge{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:.65rem;
  background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.25);color:var(--accent2);padding:4px 10px;border-radius:20px;}

/* SEARCH SCREEN */
#searchScreen{max-width:700px;margin:0 auto;padding:64px 24px 80px;}
.search-hero{text-align:center;margin-bottom:40px;}
.search-hero h2{font-family:'Syne',sans-serif;font-size:clamp(2rem,5vw,3rem);font-weight:800;
  letter-spacing:-.04em;line-height:1.1;margin-bottom:10px;}
.search-hero h2 em{font-style:italic;color:var(--accent2);}
.search-hero p{color:var(--text-dim);font-weight:300;font-size:.95rem;}
.search-card{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:28px;}
.search-card>label{display:block;font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;}

/* Autocomplete */
.ac-wrap{position:relative;}
.search-row{display:flex;gap:10px;}
.search-row input{flex:1;background:var(--surface2);border:1px solid var(--border2);color:var(--text);
  padding:13px 16px;border-radius:11px;font-family:'Inter',sans-serif;font-size:.95rem;outline:none;
  transition:border-color .2s,box-shadow .2s;}
.search-row input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,142,247,.15);}
.search-row input::placeholder{color:var(--text-muted);}
#acList{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--surface2);
  border:1px solid var(--border2);border-radius:12px;overflow:hidden;z-index:400;
  box-shadow:0 12px 40px rgba(0,0,0,.5);display:none;max-height:340px;overflow-y:auto;}
#acList.open{display:block;}
.ac-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;
  border-bottom:1px solid rgba(36,48,80,.4);transition:background .12s;gap:12px;}
.ac-item:last-child{border-bottom:none;}
.ac-item:hover,.ac-item.sel{background:rgba(79,142,247,.1);}
.ac-left h4{font-size:.87rem;font-weight:500;color:var(--text);margin-bottom:2px;line-height:1.3;}
.ac-left h4 mark{background:none;color:var(--accent2);font-weight:700;}
.ac-left p{font-family:'JetBrains Mono',monospace;font-size:.66rem;color:var(--text-muted);}
.ac-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;}
.ac-estado{font-family:'JetBrains Mono',monospace;font-size:.6rem;font-weight:700;
  padding:2px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:.05em;}
.ae-Activo{background:rgba(14,201,127,.12);color:var(--green);border:1px solid rgba(14,201,127,.3);}
.ae-Inactivo{background:rgba(240,97,74,.1);color:var(--red);border:1px solid rgba(240,97,74,.25);}
.ae-Desactualizado{background:rgba(240,180,41,.1);color:var(--gold);border:1px solid rgba(240,180,41,.25);}
.ac-msg{padding:16px;text-align:center;color:var(--text-muted);font-size:.82rem;}

/* Buttons */
.btn{padding:13px 22px;border-radius:11px;border:none;cursor:pointer;font-family:'Inter',sans-serif;
  font-weight:600;font-size:.88rem;transition:all .2s;}
.btn-primary{background:var(--accent);color:white;}
.btn-primary:hover{background:#3a78e8;transform:translateY(-1px);}
.btn-ghost{background:var(--surface2);border:1px solid var(--border2);color:var(--text-dim);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent2);}
.btn-ghost:disabled{opacity:.35;cursor:not-allowed;}
.btn-sm{padding:8px 16px;font-size:.8rem;}

.hints{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
.hints span{font-size:.73rem;color:var(--text-muted);}
.hint{font-size:.77rem;color:var(--text-dim);background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:5px 12px;cursor:pointer;transition:all .15s;}
.hint:hover{color:var(--accent2);border-color:rgba(79,142,247,.3);}

/* Results list */
#resultsList{margin-top:20px;}
.res-item{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px 20px;
  margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;
  transition:all .2s;gap:12px;}
.res-item:hover{border-color:rgba(79,142,247,.4);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,.3);}
.res-item h4{font-family:'Syne',sans-serif;font-weight:600;font-size:.9rem;margin-bottom:3px;}
.res-item h4 mark{background:none;color:var(--accent2);font-weight:700;}
.res-item p{font-size:.73rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;}
.pg-bar{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:14px;}
.pg-info{font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--text-muted);}

/* PROFILE SCREEN */
#profileScreen{display:none;max-width:1060px;margin:0 auto;padding:32px 24px 80px;}
.back-btn{display:inline-flex;align-items:center;gap:7px;color:var(--text-dim);font-size:.84rem;
  cursor:pointer;margin-bottom:24px;border:none;background:none;transition:color .2s;padding:0;font-family:'Inter',sans-serif;}
.back-btn:hover{color:var(--accent2);}

.profile-hdr{background:var(--surface);border:1px solid var(--border);border-radius:18px;
  padding:28px 32px;margin-bottom:22px;display:grid;grid-template-columns:1fr auto;gap:20px;align-items:start;}
.profile-hdr h2{font-family:'Syne',sans-serif;font-size:clamp(1.3rem,3vw,1.85rem);font-weight:800;
  letter-spacing:-.03em;line-height:1.2;margin-bottom:10px;}
.pchips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;}
.chip{font-family:'JetBrains Mono',monospace;font-size:.66rem;padding:3px 9px;border-radius:6px;
  background:var(--surface2);border:1px solid var(--border2);color:var(--text-dim);}
.chip.b{color:var(--accent2);border-color:rgba(79,142,247,.3);background:rgba(79,142,247,.08);}
.chip.g{color:var(--green);border-color:rgba(14,201,127,.3);background:rgba(14,201,127,.08);}
.chip.o{color:var(--gold);border-color:rgba(240,180,41,.3);background:rgba(240,180,41,.08);}
.pmeta{display:flex;flex-wrap:wrap;gap:14px;font-size:.81rem;color:var(--text-dim);}
.pright{display:flex;flex-direction:column;align-items:flex-end;gap:10px;}
.estado-big{font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:700;
  padding:6px 14px;border-radius:20px;text-transform:uppercase;letter-spacing:.06em;}
.eA{background:rgba(14,201,127,.12);color:var(--green);border:1px solid rgba(14,201,127,.3);}
.eI{background:rgba(240,97,74,.1);color:var(--red);border:1px solid rgba(240,97,74,.25);}
.eD{background:rgba(240,180,41,.1);color:var(--gold);border:1px solid rgba(240,180,41,.25);}
.rpe-num{font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--text-muted);}
.cert-a{font-size:.77rem;color:var(--accent2);text-decoration:none;}
.cert-a:hover{text-decoration:underline;}

/* Tabs */
.tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:5px;flex-wrap:wrap;}
.tab-btn{padding:9px 15px;border-radius:10px;border:none;cursor:pointer;font-family:'Inter',sans-serif;
  font-weight:500;font-size:.81rem;color:var(--text-muted);background:none;transition:all .2s;
  display:flex;align-items:center;gap:6px;white-space:nowrap;}
.tab-btn:hover{color:var(--text-dim);}
.tab-btn.active{background:var(--surface3);color:var(--accent2);border:1px solid rgba(79,142,247,.25);}
.count{font-family:'JetBrains Mono',monospace;font-size:.62rem;background:rgba(79,142,247,.15);
  color:var(--accent);padding:1px 6px;border-radius:10px;}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* Summary cards */
.sgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:14px;margin-bottom:18px;}
.scard{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;}
.scard .val{font-family:'Syne',sans-serif;font-size:1.65rem;font-weight:800;letter-spacing:-.03em;margin-bottom:4px;}
.scard .lbl{font-size:.73rem;color:var(--text-muted);font-weight:500;}
.ca{color:var(--accent2);} .cg{color:var(--gold);} .cgr{color:var(--green);} .cp{color:var(--purple);}

/* Table */
.twrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:14px;}
.thead-row{padding:15px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.thead-row h3{font-family:'Syne',sans-serif;font-size:.9rem;font-weight:700;}
.thead-row span{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--text-muted);}
.tscroll{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.8rem;}
th{text-align:left;padding:10px 13px;font-family:'JetBrains Mono',monospace;font-size:.62rem;
  color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid var(--border);
  font-weight:500;white-space:nowrap;}
td{padding:11px 13px;border-bottom:1px solid rgba(36,48,80,.35);color:var(--text-dim);vertical-align:top;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(79,142,247,.025);}
.mono{font-family:'JetBrains Mono',monospace;font-size:.74rem;}
td strong{color:var(--text);font-weight:500;}
.amt{font-family:'JetBrains Mono',monospace;color:var(--gold);font-size:.76rem;}
.tag{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:.61rem;padding:2px 7px;border-radius:5px;}
.tg{background:rgba(14,201,127,.12);color:var(--green);}
.tb{background:rgba(79,142,247,.12);color:var(--accent2);}
.tr{background:rgba(240,97,74,.1);color:var(--red);}
.to{background:rgba(240,180,41,.1);color:var(--gold);}
.tgr{background:rgba(77,106,153,.18);color:var(--text-muted);}
.ppag{display:flex;align-items:center;justify-content:center;gap:10px;padding:13px;border-top:1px solid var(--border);}
.xbtn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.8rem;
  padding:2px 6px;border-radius:4px;transition:color .2s;}
.xbtn:hover{color:var(--accent2);}
.det-inner{padding:14px 16px 14px 30px;background:var(--surface2);font-size:.77rem;color:var(--text-dim);}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;}
.ditem label{display:block;font-family:'JetBrains Mono',monospace;font-size:.59rem;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:.07em;margin-bottom:2px;}

/* States */
.loading{text-align:center;padding:48px 20px;}
.spin{width:30px;height:30px;border:2px solid var(--border2);border-top-color:var(--accent);
  border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 12px;}
.loading p{color:var(--text-muted);font-size:.82rem;}
.empty{text-align:center;padding:48px 20px;color:var(--text-muted);font-size:.85rem;}
.empty i{display:block;font-size:2rem;margin-bottom:10px;opacity:.5;font-style:normal;}

@keyframes spin{to{transform:rotate(360deg);}}
@media(max-width:640px){
  header{padding:12px 16px;}
  #searchScreen{padding:32px 14px 60px;}
  #profileScreen{padding:24px 14px 60px;}
  .profile-hdr{grid-template-columns:1fr;}
  .pright{flex-direction:row;align-items:center;flex-wrap:wrap;}
  .tabs{gap:2px;}
  .tab-btn{padding:8px 10px;font-size:.75rem;}
}
</style>
</head>
<body>

<header>
  <div class="logo">üèõÔ∏è</div>
  <h1>DGCP <span>Consulta</span></h1>
  <div class="hbadge">DATOS ABIERTOS RD</div>
</header>

<!-- SEARCH -->
<div id="searchScreen">
  <div class="search-hero">
    <h2>Consulta <em>proveedores</em><br>del Estado</h2>
    <p>Contratos ¬∑ Ofertas ¬∑ Resoluciones ¬∑ Sentencias SCJ ¬∑ Audiencias</p>
  </div>

  <div class="search-card">
    <label>Nombre de empresa / raz√≥n social</label>
    <div class="ac-wrap">
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="Escribe para buscar empresas..." autocomplete="off">
        <button class="btn btn-primary" onclick="doSearch()">Buscar</button>
      </div>
      <div id="acList"></div>
    </div>
    <div class="hints">
      <span>Ejemplos:</span>
      <span class="hint" onclick="setQ('Cata Multiservices')">Cata Multiservices</span>
      <span class="hint" onclick="setQ('constructora')">Constructoras</span>
      <span class="hint" onclick="setQ('farmacia')">Farmacias</span>
      <span class="hint" onclick="setQ('tecnologia')">Tecnolog√≠a</span>
    </div>
  </div>
  <div id="resultsList"></div>
</div>

<!-- PROFILE -->
<div id="profileScreen">
  <button class="back-btn" onclick="goBack()">
    <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Volver a resultados
  </button>

  <div class="profile-hdr" id="profileHdr">
    <div class="loading"><div class="spin"></div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('resumen')" id="tb-resumen">üìä Resumen</button>
    <button class="tab-btn" onclick="showTab('contratos')" id="tb-contratos">üìÑ Contratos</button>
    <button class="tab-btn" onclick="showTab('ofertas')" id="tb-ofertas">üìã Ofertas</button>
    <button class="tab-btn" onclick="showTab('resoluciones')" id="tb-resoluciones">‚öñÔ∏è Resoluciones</button>
    <button class="tab-btn" onclick="showTab('sentencias')" id="tb-sentencias">üèõÔ∏è Sentencias SCJ</button>
    <button class="tab-btn" onclick="showTab('audiencias')" id="tb-audiencias">üîî Audiencias</button>
  </div>

  <div id="p-resumen" class="tab-panel active"></div>
  <div id="p-contratos" class="tab-panel"></div>
  <div id="p-ofertas" class="tab-panel"></div>
  <div id="p-resoluciones" class="tab-panel"></div>
  <div id="p-sentencias" class="tab-panel"></div>
  <div id="p-audiencias" class="tab-panel"></div>
</div>

<script>
const DGCP  = 'https://datosabiertos.dgcp.gob.do/api-dgcp/v1';
const CIVIC = 'https://civiceye-production.up.railway.app';

let RPE=null, RNC=null, loadedTabs={};
let acTimer=null, acIdx=-1, acData=[];

// Utils
const fmt = v => (v==null||v==='') ? '‚Äî' : v;
const fmtD = d => d ? new Date(d).toLocaleDateString('es-DO',{year:'numeric',month:'short',day:'numeric'}) : '‚Äî';
const fmtM = (v,c) => { const n=parseFloat(v); return isNaN(n)?'‚Äî':n.toLocaleString('es-DO',{minimumFractionDigits:2,maximumFractionDigits:2})+(c?' '+c:''); };
const hl = (t,q) => !q||!t ? t||'' : t.replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}),'gi'),'<mark>$1</mark>');
const eTag = e => { const m={Activo:'tg',Activa:'tg',Inactivo:'tr',Inactiva:'tr',Desactualizado:'to'}; return `<span class="tag ${m[e]||'tgr'}">${e||'‚Äî'}</span>`; };
const eClass = e => ({Activo:'eA',Inactiva:'eI',Inactivo:'eI',Desactualizado:'eD'})[e]||'eI';

function detailHTML(obj, cols=6) {
  return Object.entries(obj).filter(([,v])=>v!=null&&v!=='').slice(0,14)
    .map(([k,v])=>`<div class="ditem"><label>${k.replace(/_/g,' ')}</label><span>${
      typeof v==='string'&&v.startsWith('http')?`<a href="${v}" target="_blank" style="color:var(--accent2)">Ver enlace</a>`:v
    }</span></div>`).join('');
}

// ‚îÄ‚îÄ AUTOCOMPLETE ‚îÄ‚îÄ
const inp = document.getElementById('searchInput');
const acEl = document.getElementById('acList');

inp.addEventListener('input', () => {
  clearTimeout(acTimer);
  const q = inp.value.trim();
  if (q.length < 2) { closeAC(); return; }
  acEl.className='open';
  acEl.innerHTML='<div class="ac-msg">Buscando...</div>';
  acTimer = setTimeout(()=>fetchAC(q), 300);
});

inp.addEventListener('keydown', e => {
  if (e.key==='Enter') { e.preventDefault(); acIdx>=0&&acData[acIdx] ? pickAC(acData[acIdx]) : (closeAC(),doSearch()); return; }
  if (!acEl.classList.contains('open')) return;
  if (e.key==='ArrowDown'){e.preventDefault();moveAC(1);}
  else if(e.key==='ArrowUp'){e.preventDefault();moveAC(-1);}
  else if(e.key==='Escape') closeAC();
});

document.addEventListener('click', e=>{ if(!e.target.closest('.ac-wrap')) closeAC(); });

function moveAC(d) {
  const items = acEl.querySelectorAll('.ac-item');
  if (!items.length) return;
  if (acIdx>=0) items[acIdx].classList.remove('sel');
  acIdx = Math.max(0, Math.min(items.length-1, acIdx+d));
  items[acIdx].classList.add('sel');
  items[acIdx].scrollIntoView({block:'nearest'});
}

async function fetchAC(q) {
  try {
    const r = await fetch(`${CIVIC}/companies?company=${encodeURIComponent(q)}`);
    const d = await r.json();
    acData = Array.isArray(d) ? d : (d.data||d.results||d.companies||[]);
    acIdx = -1;

    if (!acData.length) { acEl.innerHTML=`<div class="ac-msg">Sin resultados para "${q}"</div>`; return; }

    acEl.innerHTML = acData.slice(0,12).map((p,i)=>{
      const name = p.razon_social||p.name||p.company||'';
      const ec   = `ae-${(p.estado||'Inactivo').replace(/\s/g,'')}`;
      return `<div class="ac-item" onclick="pickAC(acData[${i}])">
        <div class="ac-left">
          <h4>${hl(name,q)}</h4>
          <p>RNC: ${p.numero_documento||p.rnc||'‚Äî'} ¬∑ RPE: ${p.rpe||p.id||'‚Äî'}</p>
        </div>
        <div class="ac-right">
          <span class="ac-estado ${ec}">${p.estado||'‚Äî'}</span>
          <span style="font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--text-muted)">${p.provee||''}</span>
        </div>
      </div>`;
    }).join('');
  } catch {
    acEl.innerHTML='<div class="ac-msg">Error conectando con la API</div>';
  }
}

function pickAC(p) {
  closeAC();
  inp.value = p.razon_social||p.name||p.company||'';
  loadProfile(p.rpe||p.id, p.razon_social||p.name||p.company, p.numero_documento||p.rnc);
}

function closeAC() { acEl.className=''; acEl.innerHTML=''; acIdx=-1; }

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
function setQ(q) { inp.value=q; inp.focus(); fetchAC(q); acEl.className='open'; }

async function doSearch() {
  closeAC();
  const q = inp.value.trim();
  if (!q) return;
  const rl = document.getElementById('resultsList');
  rl.innerHTML='<div class="loading"><div class="spin"></div><p>Buscando...</p></div>';
  try {
    const r = await fetch(`${CIVIC}/companies?company=${encodeURIComponent(q)}`);
    const d = await r.json();
    const list = Array.isArray(d) ? d : (d.data||d.results||d.companies||[]);
    if (!list.length) { rl.innerHTML=`<div class="empty"><i>üîç</i>Sin resultados para "<strong>${q}</strong>"</div>`; return; }
    rl.innerHTML = list.slice(0,30).map(p=>{
      const name = p.razon_social||p.name||p.company||'';
      const rpe  = p.rpe||p.id;
      const rnc  = p.numero_documento||p.rnc||'';
      const ec   = eClass(p.estado);
      return `<div class="res-item" onclick="loadProfile(${rpe},'${encodeURIComponent(name)}','${rnc}')">
        <div>
          <h4>${hl(name,q)}</h4>
          <p>RNC: ${rnc} ¬∑ RPE ${rpe}${p.municipio?' ¬∑ '+p.municipio:p.provincia?' ¬∑ '+p.provincia:''}</p>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0">
          <span class="estado-big ${ec}">${p.estado||'‚Äî'}</span>
          <span style="font-size:.7rem;color:var(--text-muted)">‚Üí Ver perfil</span>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    rl.innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
function goBack() {
  document.getElementById('profileScreen').style.display='none';
  document.getElementById('searchScreen').style.display='block';
}

async function loadProfile(rpe, nameEnc, rnc) {
  RPE=rpe; RNC=rnc; loadedTabs={};
  document.getElementById('searchScreen').style.display='none';
  document.getElementById('profileScreen').style.display='block';
  document.getElementById('profileHdr').innerHTML='<div class="loading"><div class="spin"></div></div>';

  ['resumen','contratos','ofertas','resoluciones','sentencias','audiencias'].forEach(t=>{
    document.getElementById(`p-${t}`).innerHTML='';
    const b=document.getElementById(`tb-${t}`);
    b.querySelectorAll('.count').forEach(e=>e.remove());
  });
  showTab('resumen',true);

  try {
    const r = await fetch(`${DGCP}/proveedores?rpe=${rpe}`);
    const d = await r.json();
    const p = d.payload?.content?.[0];
    if (!p) throw new Error('No encontrado');
    RNC = p.numero_documento||rnc;
    renderHdr(p);
    loadTab('resumen');
  } catch(e) {
    document.getElementById('profileHdr').innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>${e.message}</div>`;
  }
}

function renderHdr(p) {
  const ec = eClass(p.estado);
  document.getElementById('profileHdr').innerHTML=`
    <div>
      <h2>${p.razon_social}</h2>
      <div class="pchips">
        <span class="chip b">${p.tipo_documento}: ${p.numero_documento}</span>
        ${p.forma_juridica?`<span class="chip">${p.forma_juridica}</span>`:''}
        ${p.es_mipyme==='Si'?`<span class="chip g">MIPYME ‚úì</span>`:''}
        ${p.certificacion_micm==='Si'?`<span class="chip o">Cert. MICM</span>`:''}
        ${p.clasificacion&&p.clasificacion!=='No clasificada'?`<span class="chip">${p.clasificacion}</span>`:''}
      </div>
      <div class="pmeta">
        ${p.direccion?`<span>üìç ${p.direccion}</span>`:''}
        ${p.telefono_comercial?`<span>üìû ${p.telefono_comercial}</span>`:''}
        ${p.correo_comercial?`<span>‚úâÔ∏è ${p.correo_comercial}</span>`:''}
        ${p.provee?`<span>üì¶ ${p.provee}</span>`:''}
        ${p.fecha_creacion_empresa?`<span>üìÖ Fundada ${new Date(p.fecha_creacion_empresa).getFullYear()}</span>`:''}
      </div>
      ${p.contacto?`<div style="margin-top:10px;font-size:.77rem;color:var(--text-muted)">
        Contacto: <span style="color:var(--text-dim)">${p.contacto}${p.posicion_contacto?' ¬∑ '+p.posicion_contacto:''}${p.telefono_contacto?' ¬∑ '+p.telefono_contacto:''}</span>
      </div>`:''}
    </div>
    <div class="pright">
      <span class="estado-big ${ec}">${p.estado||'‚Äî'}</span>
      <span class="rpe-num">RPE #${p.rpe}</span>
      ${p.url_certificacion?`<a href="${p.url_certificacion}" target="_blank" class="cert-a">‚Üì Constancia</a>`:''}
    </div>`;
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function showTab(name, skip) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(`tb-${name}`).classList.add('active');
  document.getElementById(`p-${name}`).classList.add('active');
  if (!skip && !loadedTabs[name]) loadTab(name);
}
function loadTab(name) {
  loadedTabs[name]=true;
  ({resumen:loadResumen,contratos:loadContratos,ofertas:loadOfertas,
    resoluciones:loadResoluciones,sentencias:loadSentencias,audiencias:loadAudiencias})[name]?.();
}
function pLoad(id) { document.getElementById(`p-${id}`).innerHTML='<div class="loading"><div class="spin"></div><p>Cargando...</p></div>'; }
function setN(id,n) {
  const b=document.getElementById(`tb-${id}`);
  b.querySelectorAll('.count').forEach(e=>e.remove());
  if(n>0) b.innerHTML+=` <span class="count">${n.toLocaleString('es-DO')}</span>`;
}
function toggleDet(id) {
  const r=document.getElementById(id);
  const b=r?.previousElementSibling?.querySelector('.xbtn');
  if(!r) return;
  const open=r.style.display!=='none';
  r.style.display=open?'none':'table-row';
  if(b) b.textContent=open?'‚ñ∏':'‚ñæ';
}

// ‚îÄ‚îÄ RESUMEN ‚îÄ‚îÄ
async function loadResumen() {
  pLoad('resumen');
  const panel=document.getElementById('p-resumen');
  try {
    const [cR,oR]=await Promise.allSettled([
      fetch(`${DGCP}/contratos?limit=1000&page=1&rpe=${RPE}`).then(r=>r.json()),
      fetch(`${DGCP}/ofertas?limit=10000&rpe=${RPE}`).then(r=>r.json())
    ]);
    const cL=cR.status==='fulfilled'?(cR.value.payload?.content||[]):[];
    const oL=oR.status==='fulfilled'?(oR.value.payload?.content||[]):[];
    const tC=cR.status==='fulfilled'?(cR.value.totalResults||cL.length):0;
    const tO=oR.status==='fulfilled'?(oR.value.totalResults||oL.length):0;

    let tot=0, mons={}, inst={}, yrs={};
    cL.forEach(c=>{
      const v=parseFloat(c.monto_contrato||c.monto||0); if(!isNaN(v)) tot+=v;
      const m=c.moneda||'RD$'; mons[m]=(mons[m]||0)+1;
      const i=c.nombre_institucion||c.institucion; if(i) inst[i]=(inst[i]||0)+1;
      const y=c.fecha_contrato?new Date(c.fecha_contrato).getFullYear():null;
      if(y) yrs[y]=(yrs[y]||0)+1;
    });
    const monP=Object.keys(mons).sort((a,b)=>mons[b]-mons[a])[0]||'RD$';
    const topI=Object.entries(inst).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const years=Object.entries(yrs).sort((a,b)=>b[0]-a[0]);
    const maxY=Math.max(...years.map(([,v])=>v),1);

    panel.innerHTML=`
      <div class="sgrid">
        <div class="scard"><div class="val ca">${tC.toLocaleString('es-DO')}</div><div class="lbl">Contratos adjudicados</div></div>
        <div class="scard"><div class="val cg" style="font-size:1.15rem">${fmtM(tot,monP)}</div><div class="lbl">Monto total contratado</div></div>
        <div class="scard"><div class="val cgr">${tO.toLocaleString('es-DO')}</div><div class="lbl">Ofertas presentadas</div></div>
        <div class="scard"><div class="val cp">${Object.keys(inst).length}</div><div class="lbl">Instituciones contratantes</div></div>
      </div>
      ${topI.length?`<div class="twrap"><div class="thead-row"><h3>Top Instituciones</h3></div>
        <table><thead><tr><th>#</th><th>Instituci√≥n</th><th>Contratos</th></tr></thead>
        <tbody>${topI.map(([k,v],i)=>`<tr><td class="mono">${i+1}</td><td><strong>${k}</strong></td><td class="mono">${v}</td></tr>`).join('')}</tbody></table>
      </div>`:''}
      ${years.length?`<div class="twrap"><div class="thead-row"><h3>Contratos por A√±o</h3></div>
        <table><thead><tr><th>A√±o</th><th>N¬∞</th><th>Distribuci√≥n</th></tr></thead>
        <tbody>${years.map(([y,n])=>`<tr><td class="mono">${y}</td><td class="mono">${n}</td>
          <td><div style="display:flex;align-items:center;gap:8px">
            <div style="height:5px;width:${Math.round((n/maxY)*150)}px;min-width:3px;background:var(--accent);border-radius:3px;opacity:.7"></div>
            <span style="font-size:.7rem;color:var(--text-muted)">${tC?Math.round((n/tC)*100):0}%</span>
          </div></td></tr>`).join('')}</tbody></table>
      </div>`:''}`;
  } catch(e) { panel.innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>${e.message}</div>`; }
}

// ‚îÄ‚îÄ CONTRATOS ‚îÄ‚îÄ
async function loadContratos(pg=1) {
  pLoad('contratos');
  const panel=document.getElementById('p-contratos');
  try {
    const r=await fetch(`${DGCP}/contratos?limit=20&page=${pg}&rpe=${RPE}`);
    const d=await r.json();
    const list=d.payload?.content||[];
    const total=d.totalResults||0, pages=d.pages||1;
    setN('contratos',total);
    if(!list.length){panel.innerHTML='<div class="empty"><i>üìÑ</i>Sin contratos.</div>';return;}

    const rows=list.map((c,i)=>{
      const id=`c${pg}_${i}`;
      return `<tr>
        <td><button class="xbtn" onclick="toggleDet('d${id}')">‚ñ∏</button></td>
        <td><strong>${fmt(c.descripcion||c.nombre_proceso||c.proceso||c.objeto)}</strong><br>
          <span style="font-size:.68rem;color:var(--text-muted)">${fmt(c.numero_contrato||c.referencia||c.numero_proceso)}</span></td>
        <td style="font-size:.74rem">${fmt(c.nombre_institucion||c.institucion)}</td>
        <td class="amt">${fmtM(c.monto_contrato||c.monto,c.moneda)}</td>
        <td class="mono" style="font-size:.71rem">${fmtD(c.fecha_contrato||c.fecha)}</td>
        <td>${c.tipo_compra||c.modalidad?`<span class="tag tb">${c.tipo_compra||c.modalidad}</span>`:'‚Äî'}</td>
      </tr>
      <tr id="d${id}" style="display:none"><td colspan="6">
        <div class="det-inner"><div class="dgrid">${detailHTML(c)}</div></div>
      </td></tr>`;
    }).join('');

    panel.innerHTML=`<div class="twrap">
      <div class="thead-row"><h3>Contratos Adjudicados</h3><span>${total.toLocaleString('es-DO')} contratos</span></div>
      <div class="tscroll"><table>
        <thead><tr><th></th><th>Descripci√≥n / N¬∞ Contrato</th><th>Instituci√≥n</th><th>Monto</th><th>Fecha</th><th>Modalidad</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>
      ${pages>1?`<div class="ppag">
        <button class="btn btn-ghost btn-sm" ${pg<=1?'disabled':''} onclick="loadContratos(${pg-1})">‚Üê</button>
        <span class="pg-info">${pg} / ${pages}</span>
        <button class="btn btn-ghost btn-sm" ${pg>=pages?'disabled':''} onclick="loadContratos(${pg+1})">‚Üí</button>
      </div>`:''}
    </div>`;
  } catch(e){panel.innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>${e.message}</div>`;}
}

// ‚îÄ‚îÄ OFERTAS ‚îÄ‚îÄ
async function loadOfertas() {
  pLoad('ofertas');
  const panel=document.getElementById('p-ofertas');
  try {
    const r=await fetch(`${DGCP}/ofertas?limit=500&rpe=${RPE}`);
    const d=await r.json();
    const list=d.payload?.content||[];
    const total=d.totalResults||list.length;
    setN('ofertas',total);
    if(!list.length){panel.innerHTML='<div class="empty"><i>üìã</i>Sin ofertas.</div>';return;}

    const ganadas=list.filter(o=>{
      const e=(o.estado_oferta||o.estado||'').toLowerCase();
      return e.includes('adjudicad')||o.adjudicado===true;
    }).length;
    const pct=total>0?Math.round((ganadas/total)*100):0;

    const rows=list.slice(0,200).map((o,i)=>{
      const id=`o${i}`;
      const est=o.estado_oferta||o.estado||'‚Äî';
      const won=est.toLowerCase().includes('adjudicad');
      return `<tr>
        <td><button class="xbtn" onclick="toggleDet('d${id}')">‚ñ∏</button></td>
        <td><strong>${fmt(o.descripcion||o.nombre_proceso||o.proceso||o.objeto)}</strong><br>
          <span style="font-size:.68rem;color:var(--text-muted)">${fmt(o.numero_proceso||o.referencia)}</span></td>
        <td style="font-size:.74rem">${fmt(o.nombre_institucion||o.institucion)}</td>
        <td class="amt">${fmtM(o.monto_ofertado||o.monto,o.moneda)}</td>
        <td class="mono" style="font-size:.71rem">${fmtD(o.fecha_apertura||o.fecha)}</td>
        <td><span class="tag ${won?'tg':'tgr'}">${est}</span></td>
      </tr>
      <tr id="d${id}" style="display:none"><td colspan="6">
        <div class="det-inner"><div class="dgrid">${detailHTML(o)}</div></div>
      </td></tr>`;
    }).join('');

    panel.innerHTML=`
      <div class="sgrid" style="margin-bottom:14px">
        <div class="scard"><div class="val ca">${total.toLocaleString('es-DO')}</div><div class="lbl">Total ofertas</div></div>
        <div class="scard"><div class="val cgr">${ganadas}</div><div class="lbl">Adjudicadas</div></div>
        <div class="scard"><div class="val cg">${pct}%</div><div class="lbl">Tasa de √©xito</div></div>
      </div>
      <div class="twrap">
        <div class="thead-row"><h3>Ofertas Presentadas</h3><span>${total.toLocaleString('es-DO')} total</span></div>
        <div class="tscroll"><table>
          <thead><tr><th></th><th>Proceso</th><th>Instituci√≥n</th><th>Monto Ofertado</th><th>Fecha</th><th>Estado</th></tr></thead>
          <tbody>${rows}</tbody>
        </table></div>
      </div>`;
  } catch(e){panel.innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>${e.message}</div>`;}
}

// ‚îÄ‚îÄ RESOLUCIONES ‚îÄ‚îÄ
async function loadResoluciones(skip=0) {
  pLoad('resoluciones');
  const panel=document.getElementById('p-resoluciones');
  const lim=10;
  try {
    const r=await fetch(`${CIVIC}/dgcp_resolutions?skip=${skip}&limit=${lim}&rpe=${RPE}`);
    const d=await r.json();
    const list=Array.isArray(d)?d:(d.data||d.results||d.items||[]);
    const total=d.total||d.count||list.length;
    setN('resoluciones',total);
    if(!list.length){panel.innerHTML='<div class="empty"><i>‚öñÔ∏è</i>Sin resoluciones DGCP.</div>';return;}

    const rows=list.map((x,i)=>{
      const id=`res${skip}_${i}`;
      return `<tr>
        <td><button class="xbtn" onclick="toggleDet('d${id}')">‚ñ∏</button></td>
        <td class="mono"><strong>${fmt(x.numero_resolucion||x.resolucion||x.numero||x.id)}</strong></td>
        <td>${fmt(x.descripcion||x.asunto||x.motivo||x.tipo)}</td>
        <td class="mono" style="font-size:.71rem">${fmtD(x.fecha||x.fecha_resolucion||x.created_at)}</td>
        <td>${x.estado?eTag(x.estado):'‚Äî'}</td>
      </tr>
      <tr id="d${id}" style="display:none"><td colspan="5">
        <div class="det-inner"><div class="dgrid">${detailHTML(x)}</div></div>
      </td></tr>`;
    }).join('');

    panel.innerHTML=`<div class="twrap">
      <div class="thead-row"><h3>Resoluciones DGCP</h3><span>${total} registros</span></div>
      <div class="tscroll"><table>
        <thead><tr><th></th><th>N¬∞ Resoluci√≥n</th><th>Descripci√≥n</th><th>Fecha</th><th>Estado</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>
      <div class="ppag">
        <button class="btn btn-ghost btn-sm" ${skip<=0?'disabled':''} onclick="loadResoluciones(${Math.max(0,skip-lim)})">‚Üê</button>
        <span class="pg-info">${skip+1}‚Äì${Math.min(skip+lim,total)} de ${total}</span>
        <button class="btn btn-ghost btn-sm" ${skip+lim>=total?'disabled':''} onclick="loadResoluciones(${skip+lim})">‚Üí</button>
      </div>
    </div>`;
  } catch(e){panel.innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>${e.message}</div>`;}
}

// ‚îÄ‚îÄ SENTENCIAS ‚îÄ‚îÄ
async function loadSentencias(start=0) {
  pLoad('sentencias');
  const panel=document.getElementById('p-sentencias');
  const len=10;
  try {
    const r=await fetch(`${CIVIC}/judicial-cases/?search=${RNC}&start=${start}&length=${len}`);
    const d=await r.json();
    const list=Array.isArray(d)?d:(d.data||d.results||d.items||[]);
    const total=d.recordsTotal||d.total||d.count||list.length;
    setN('sentencias',total);
    if(!list.length){panel.innerHTML=`<div class="empty"><i>üèõÔ∏è</i>Sin sentencias SCJ para RNC ${RNC}.</div>`;return;}

    const rows=list.map((s,i)=>{
      const id=`s${start}_${i}`;
      return `<tr>
        <td><button class="xbtn" onclick="toggleDet('d${id}')">‚ñ∏</button></td>
        <td class="mono"><strong>${fmt(s.numero_expediente||s.expediente||s.caso||s.id)}</strong></td>
        <td>${fmt(s.materia||s.tipo||s.asunto||s.descripcion)}</td>
        <td class="mono" style="font-size:.71rem">${fmtD(s.fecha||s.fecha_sentencia||s.date||s.created_at)}</td>
        <td>${s.resultado||s.decision||s.fallo?`<span class="tag tb">${s.resultado||s.decision||s.fallo}</span>`:'‚Äî'}</td>
      </tr>
      <tr id="d${id}" style="display:none"><td colspan="5">
        <div class="det-inner"><div class="dgrid">${detailHTML(s)}</div></div>
      </td></tr>`;
    }).join('');

    panel.innerHTML=`<div class="twrap">
      <div class="thead-row"><h3>Sentencias ‚Äî Suprema Corte de Justicia</h3><span>${total} registros</span></div>
      <div class="tscroll"><table>
        <thead><tr><th></th><th>N¬∞ Expediente</th><th>Materia</th><th>Fecha</th><th>Resultado</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>
      <div class="ppag">
        <button class="btn btn-ghost btn-sm" ${start<=0?'disabled':''} onclick="loadSentencias(${Math.max(0,start-len)})">‚Üê</button>
        <span class="pg-info">${start+1}‚Äì${Math.min(start+len,total)} de ${total}</span>
        <button class="btn btn-ghost btn-sm" ${start+len>=total?'disabled':''} onclick="loadSentencias(${start+len})">‚Üí</button>
      </div>
    </div>`;
  } catch(e){panel.innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>${e.message}</div>`;}
}

// ‚îÄ‚îÄ AUDIENCIAS ‚îÄ‚îÄ
async function loadAudiencias(pg=1) {
  pLoad('audiencias');
  const panel=document.getElementById('p-audiencias');
  const ps=20;
  try {
    const r=await fetch(`${CIVIC}/judicial_power/?page=${pg}&page_size=${ps}&identifier=${RNC}`);
    const d=await r.json();
    const list=Array.isArray(d)?d:(d.data||d.results||d.items||[]);
    const total=d.total||d.count||list.length;
    const pages=Math.ceil(total/ps)||1;
    setN('audiencias',total);
    if(!list.length){panel.innerHTML=`<div class="empty"><i>üîî</i>Sin audiencias para RNC ${RNC}.</div>`;return;}

    const rows=list.map((a,i)=>{
      const id=`a${pg}_${i}`;
      return `<tr>
        <td><button class="xbtn" onclick="toggleDet('d${id}')">‚ñ∏</button></td>
        <td class="mono"><strong>${fmt(a.numero_expediente||a.expediente||a.caso||a.id)}</strong></td>
        <td style="font-size:.74rem">${fmt(a.tribunal||a.juzgado||a.organo||a.corte)}</td>
        <td>${fmt(a.materia||a.tipo||a.asunto)}</td>
        <td class="mono" style="font-size:.71rem">${fmtD(a.fecha_audiencia||a.fecha||a.date)}</td>
        <td>${a.estado?eTag(a.estado):'‚Äî'}</td>
      </tr>
      <tr id="d${id}" style="display:none"><td colspan="6">
        <div class="det-inner"><div class="dgrid">${detailHTML(a)}</div></div>
      </td></tr>`;
    }).join('');

    panel.innerHTML=`<div class="twrap">
      <div class="thead-row"><h3>Audiencias Judiciales ‚Äî Poder Judicial</h3><span>${total} registros</span></div>
      <div class="tscroll"><table>
        <thead><tr><th></th><th>Expediente</th><th>Tribunal</th><th>Materia</th><th>Fecha</th><th>Estado</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>
      <div class="ppag">
        <button class="btn btn-ghost btn-sm" ${pg<=1?'disabled':''} onclick="loadAudiencias(${pg-1})">‚Üê</button>
        <span class="pg-info">${pg} / ${pages} ¬∑ ${total} registros</span>
        <button class="btn btn-ghost btn-sm" ${pg>=pages?'disabled':''} onclick="loadAudiencias(${pg+1})">‚Üí</button>
      </div>
    </div>`;
  } catch(e){panel.innerHTML=`<div class="empty"><i>‚ö†Ô∏è</i>${e.message}</div>`;}
}
</script>
</body>
</html>
